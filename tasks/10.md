# Title
Написание тестов для всех модулей

# Description
Написать тесты для всех модулей проекта ДО реализации (TDD подход).

## Структура тестов
```
src/
  config/
    config.test.ts
  storage/
    storage.test.ts
  index/
    index.test.ts
  parser/
    parser.test.ts
  cli/
    commands.test.ts
```

---

## 0. Index Module (src/index/index.test.ts)

### Контракт
```ts
// tasks/.hod/index.json - только зависимости
interface IndexData {
  [taskId: string]: string[];  // "1.1": ["1"] - taskId -> dependencies
}

interface IndexService {
  load(): Promise<IndexData>;
  update(taskId: string, dependencies: string[]): Promise<void>;
  remove(taskId: string): Promise<void>;
  rebuild(tasks: Task[]): Promise<void>;  // пересборка из markdown
  getNextTasks(allStatuses: Record<string, string>): string[];
}
```

### Тест-кейсы
```typescript
describe('IndexService', () => {
  describe('load()', () => {
    it('должен загрузить index.json')
    it('должен вернуть пустой объект если файл не существует')
    it('должен выбросить ошибку если JSON невалиден')
  })

  describe('update()', () => {
    it('должен обновить зависимости задачи')
    it('должен создать запись если taskId не существует')
    it('должен установить пустой массив если нет зависимостей')
  })

  describe('remove()', () => {
    it('должен удалить taskId из индекса')
    it('должен быть noop если taskId не существует')
  })

  describe('rebuild()', () => {
    it('должен пересобрать индекс из списка задач')
    it('должен очистить старые записи')
    it('должен сохранить зависимости из парсенных задач')
  })

  describe('getNextTasks()', () => {
    it('должен вернуть задачи без зависимостей со статусом pending')
    it('должен вернуть задачи у которых все зависимости completed')
    it('должен вернуть пустой массив если нет готовых задач')
    it('должен игнорировать задачи со статусом completed')
    it('должен корректно обрабатывать циклические зависимости')
  })
})
```

### Формат index.json
```json
{
  "1": [],
  "2": ["1"],
  "3": ["1", "2"],
  "1.1": ["1"],
  "1.2": ["1", "1.1"]
}
```

---

## 1. Config Module (src/config/config.test.ts)

### Контракт
```ts
interface Config {
  tasksDir: string;
  fields: {
    title: { key: string; required: true };
    description?: { key: string };  // предусмотрен, не required
    status?: { key: string; default: string };
    // ... другие кастомные поля
  };
}

interface ConfigService {
  load(path?: string): Promise<Config>;
  validate(config: Config): void;
}
```

### Тест-кейсы
```typescript
describe('ConfigService', () => {
  describe('load()', () => {
    it('должен загрузить конфиг из hod.config.yml')
    it('должен добавить description если его нет в конфиге')
    it('должен выбросить ошибку если файл не найден')
    it('должен выбросить ошибку если YAML невалиден')
  })

  describe('validate()', () => {
    it('должен пройти валидацию с корректным конфигом')
    it('должен выбросить ошибку если tasksDir не указан')
    it('должен выбросить ошибку если title не указан')
    it('должен выбросить ошибку если title.key пустой')
  })
})
```

### Пример hod.config.yml
```yaml
tasksDir: ./tasks
fields:
  title:
    key: Title
    required: true
  description:          # предусмотрен системой
    key: Description
  status:
    key: Status
    default: pending
  priority:
    key: Priority
```

---

## 2. Storage Module (src/storage/storage.test.ts)

### Контракт
```ts
interface Task {
  id: string;
  content: string;
}

interface StorageService {
  create(id: string, content: string): Promise<void>;
  read(id: string): Promise<string>;
  update(id: string, content: string): Promise<void>;
  delete(id: string): Promise<void>;
  list(): Promise<Task[]>;
  exists(id: string): Promise<boolean>;
}
```

### Тест-кейсы
```typescript
describe('StorageService', () => {
  describe('create()', () => {
    it('должен создать файл задачи {id}.md')
    it('должен выбросить ошибку если файл уже существует')
    it('должен создать директорию если её нет')
  })

  describe('read()', () => {
    it('должен прочитать содержимое файла')
    it('должен выбросить ошибку если файл не найден')
  })

  describe('update()', () => {
    it('должен обновить содержимое файла')
    it('должен выбросить ошибку если файл не найден')
  })

  describe('delete()', () => {
    it('должен удалить файл')
    it('должен быть noop если файл не существует')
  })

  describe('list()', () => {
    it('должен вернуть список всех задач')
    it('должен вернуть пустой массив если директория пуста')
    it('должен игнорировать .hod директорию')
    it('должен игнорировать файлы не подходящие под паттерн *.md')
  })

  describe('exists()', () => {
    it('должен вернуть true если файл существует')
    it('должен вернуть false если файл не существует')
  })
})
```

---

## 3. Parser Module (src/parser/parser.test.ts)

### Контракт
```ts
interface ParsedTask {
  id: string;
  title: string;
  description?: string;
  status: string;
  dependencies: string[];  // всегда есть, минимум []
  [key: string]: string | string[] | undefined;
}

interface ParserService {
  parse(id: string, markdown: string): ParsedTask;
  serialize(task: ParsedTask): string;
}
```

### Формат Markdown
```markdown
# Title
Название задачи

# Description
Описание задачи

# Status
pending

# Dependencies
1, 2, 5
```

**Примечание**: `# Dependencies` всегда присутствует, может быть пустым.

### Тест-кейсы
```typescript
describe('ParserService', () => {
  describe('parse()', () => {
    it('должен распарсить все поля задачи')
    it('должен распарсить Dependencies как массив строк')
    it('должен вернуть пустой массив если Dependencies пустой')
    it('должен вернуть пустой массив если Dependencies отсутствует (fallback)')
    it('должен работать с пустым description')
    it('должен работать с многострочными значениями')
    it('должен игнорировать неизвестные поля')
  })

  describe('serialize()', () => {
    it('должен сериализовать задачу в markdown')
    it('должен всегда добавлять #Dependencies (пустой если нет)')
    it('должен правильно сериализовать Dependencies (через запятую)')
    it('должен пропускать пустые поля кроме Dependencies')
  })
})
```

---

## 4. CLI Commands (src/cli/commands.test.ts)

### Контракт команд

#### `hod add`
```bash
hod add --id 1 --title "Заголовок" --description "Описание"
```
- Создает markdown файл
- Обновляет index.json с dependencies=[]

#### `hod list`
```bash
hod list                    # все задачи
hod list --status pending   # фильтр по статусу
hod list --json             # JSON формат
```

#### `hod update`
```bash
hod update --id 1 --status completed --title "Новое название"
hod update --id 1 --dependencies 2,3  # обновляет зависимости и index
```

#### `hod delete`
```bash
hod delete --id 1
hod delete --id 1 --force    # без подтверждения
```
- Удаляет файл и запись из index.json

#### `hod init`
```bash
hod init                    # интерактивно
hod init --dir ./tasks      # с параметрами
```

#### `hod next`
```bash
hod next        # следующие задачи
hod next --all  # все с зависимостями
```
- Читает статусы из markdown
- Читает зависимости из index.json
- Вычисляет доступные задачи

#### `hod sync`
```bash
hod sync        # пересобрать index.json из markdown
```

### Тест-кейсы
```typescript
describe('CLI Commands', () => {
  describe('hod add', () => {
    it('должен создать задачу с --id и --title')
    it('должен сгенерировать ID если не указан --id')
    it('должен использовать дефолтные поля из конфига')
    it('должен создать запись в index.json с dependencies=[]')
    it('должен выбросить ошибку если title не указан')
  })

  describe('hod list', () => {
    it('должен вывести список задач в табличном виде')
    it('должен фильтровать по --status')
    it('должен выводить JSON если указан --json')
    it('должен показывать пустой список если задач нет')
  })

  describe('hod update', () => {
    it('должен обновить указанные поля задачи')
    it('должен обновить index.json при изменении dependencies')
    it('должен выбросить ошибку если задача не найдена')
  })

  describe('hod delete', () => {
    it('должен удалить задачу по ID')
    it('должен удалить запись из index.json')
    it('должен запросить подтверждение если нет --force')
    it('должен выбросить ошибку если задача не найдена')
  })

  describe('hod init', () => {
    it('должен создать hod.config.yml с дефолтными значениями')
    it('должен создать tasks/.hod/ директорию')
    it('должен создать пустой index.json')
    it('должен использовать --dir если указан')
    it('должен быть noop если конфиг уже существует')
  })

  describe('hod next', () => {
    it('должен показать задачи с выполненными зависимостями')
    it('должен читать статусы из markdown')
    it('должен читать зависимости из index.json')
    it('должен показывать "нет задач" если все выполнены')
  })

  describe('hod sync', () => {
    it('должен пересобрать index.json из всех markdown файлов')
    it('должен очистить несуществующие задачи из индекса')
  })
})
```

---

## 5. Моки

### ConfigService mock
```typescript
const mockConfig = {
  tasksDir: './tasks',
  fields: {
    title: { key: 'Title', required: true },
    description: { key: 'Description' },
    status: { key: 'Status', default: 'pending' },
  }
};
```

### IndexService mock
```typescript
const mockIndex = {
  load: vi.fn().mockResolvedValue({}),
  update: vi.fn(),
  remove: vi.fn(),
  rebuild: vi.fn(),
  getNextTasks: vi.fn().mockReturnValue([]),
};
```

### StorageService mock
```typescript
const mockStorage = {
  create: vi.fn(),
  read: vi.fn(),
  update: vi.fn(),
  delete: vi.fn(),
  list: vi.fn(),
  exists: vi.fn(),
};
```

---

## Чек-лист перед реализацией
- [ ] Все тест-кейсы описаны
- [ ] Контракты интерфейсов определены
- [ ] Моки подготовлены
- [ ] Примеры данных для тестов есть

# DependsOn
11

# Priority
high
