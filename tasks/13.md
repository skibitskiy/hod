# Title
Создание модуля индекса (index)

# Description
Реализовать управление индексом зависимостей `tasks/.hod/index.json`.

## Функционал

### IndexService
```ts
interface IndexData {
  [taskId: string]: string[];  // taskId -> dependencies
}

interface TaskDependencies {
  id: string;
  dependencies: string[];
}

interface IndexService {
  load(): Promise<IndexData>;
  update(taskId: string, dependencies: string[]): Promise<void>;
  remove(taskId: string): Promise<void>;
  rebuild(tasks: TaskDependencies[]): Promise<void>;
  getNextTasks(allStatuses: Record<string, string>): string[];
}
```

**Примечание:** `rebuild()` принимает `TaskDependencies[]`, не зависит от Storage или Parser. CLI layer orchestrates парсинг.

### Методы

- `load()` — загрузить index.json, вернуть {} если файл не существует
- `update(taskId, deps)` — обновить зависимости задачи (валидация + атомарная запись)
- `remove(taskId)` — удалить задачу из индекса (no-op если не существует)
- `rebuild(tasks)` — пересобрать индекс из списка задач (для `hod sync`)
- `getNextTasks(statuses)` — вернуть ID задач готовых к выполнению

### Атомарные операции

`update()` и `rebuild()` используют atomic write-replace (POSIX):
```ts
const tempPath = `${indexPath}.tmp`;
await fs.unlink(tempPath).catch(() => {});
await fs.writeFile(tempPath, JSON.stringify(data, null, 2));
await fs.rename(tempPath, indexPath);  // atomic on POSIX
```

### Логика getNextTasks

Задача готова к выполнению если:
1. Её статус `!== 'completed'`
2. Все зависимости выполнены (status === `'completed'`)
3. Задача присутствует в `allStatuses`

**Порядок:** sorted by ID (numeric, как `storage.list()`)
**Skip:** задачи missing из `allStatuses` игнорируются

### Формат index.json

```json
{
  "1": [],
  "2": ["1"],
  "3": ["1", "2"],
  "1.1": ["1"],
  "1.2": ["1", "1.1"]
}
```

## Обработка ошибок

```ts
class IndexLoadError extends Error {
  constructor(message: string, public cause?: Error) {
    super(message);
    this.name = 'IndexLoadError';
  }
}

class IndexWriteError extends Error {
  constructor(message: string, public cause?: Error) {
    super(message);
    this.name = 'IndexWriteError';
  }
}

class IndexCorruptionError extends Error {
  constructor(message: string, public cause?: Error) {
    super(message);
    this.name = 'IndexCorruptionError';
  }
}

class IndexValidationError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'IndexValidationError';
  }
}

class CircularDependencyError extends Error {
  constructor(message: string, public cycle: string[]) {
    super(message);
    this.name = 'CircularDependencyError';
  }
}
```

### Error mapping

- `load()` с invalid JSON → `IndexCorruptionError`
- `load()` с access error → `IndexLoadError`
- `writeFile`/`rename` failures → `IndexWriteError`
- Invalid ID format в `rebuild()` → `IndexValidationError`
- Обнаружен cycle → `CircularDependencyError`

## Валидация

### update() проверяет:

1. **Circular dependency** — traverse graph от taskId, если найден cycle → `CircularDependencyError`
2. **Self-dependency** — taskId в своих deps → `CircularDependencyError`
3. **ID format** — regex `^\d+(\.\d+)*$` (как в Storage), max 50 chars
4. **ID length** — максимум 50 символов
5. **Duplicates** — auto-dedup зависимости
6. **Whitespace** — trim каждый dependency ID

**Примечание:** `update()` НЕ проверяет что dependency IDs существуют в индексе (bootstrap problem). Валидация existence только в `rebuild()`.

### rebuild() проверяет:

- ID format (regex `^\d+(\.\d+)*$`)
- ID length (max 50 chars)
- Circular dependencies (полный граф)
- Duplicate task IDs в input → `IndexValidationError`
- Duplicate dependencies — auto-dedup
- Whitespace — trim

### Cycle detection algorithm

DFS с coloring (white/gray/black):
- O(V+E) complexity
- Возвращает cycle path для error message

## Интеграция

### Путь к файлу

`{tasksDir}/.hod/index.json` — hardcoded внутри tasksDir

### Создание директории

Shared helper `ensureHodDirectory()`:
- Вызывается из `update()` и `rebuild()` перед записью
- `load()` НЕ создаёт директорию
- Создаёт `.hod/` внутри `tasksDir`

### Конструктор

```ts
class IndexServiceImpl implements IndexService {
  constructor(
    private readonly tasksDir: string,
    private readonly fs: FsModule = defaultFs,
  ) {}
}
```

- Dependency injection `fs` для тестирования
- Разрешает `tasksDir` как абсолютный путь
- НЕ проверяет что `tasksDir` существует (fail-late)
- НЕ создаёт директории в конструкторе

### Экспорт из `src/index/index.ts`

- Interface `IndexService`
- Class `IndexServiceImpl`
- Factory `createIndexService(tasksDir: string, fs?: FsModule): IndexService`
- Все error classes
- Type `IndexData`
- Type `TaskDependencies`

### Shared utility

Extract `sortIds()` из Storage в `src/utils/sort.ts`:
- Numeric sort по сегментам ID
- Используется в `getNextTasks()` и Storage

### Конкурентность

**Не поддерживается в v1.** Документация: multiple CLI instances → last writer wins (atomic rename). File locking не реализуется.

## Edge cases

### load()

- Файл не существует → вернуть `{}`
- `.hod/` не существует → вернуть `{}`
- Invalid JSON → `IndexCorruptionError`
- Пустой файл (`{}`) → вернуть `{}`
- Пустой массив (`[]`) → нормализовать в `{}` (resilience)
- Non-array values в JSON → `IndexCorruptionError` (валидация типа)

### update()

- Пустой массив deps → валидно, сохраняет `[]`
- Дубликаты в deps → auto-dedup
- Whitespace в deps → auto-trim
- taskId не существует в индексе → добавить новую запись
- Circular dependency → `CircularDependencyError` с cycle path
- Invalid ID format → `IndexValidationError`
- ID > 50 chars → `IndexValidationError`

### remove()

- taskId не существует → no-op (idempotent)
- Index manages only dependencies — не проверяет orphaned deps

### rebuild()

- Пустой массив → записать `{}`
- Duplicate task IDs в input → `IndexValidationError`
- Invalid ID format → `IndexValidationError`
- ID > 50 chars → `IndexValidationError`
- Circular dependency → `CircularDependencyError`

### getNextTasks()

- allStatuses пустой → вернуть `[]`
- Задача в индексе но missing из `allStatuses` → skip
- Задача имеет dependency на missing из индекса → skip (orphaned reference)
- Задача имеет dependency на missing из `allStatuses` → skip

## Лимиты

- Нет лимита на количество dependencies у задачи
- Нет лимита на общее количество задач

# Status
completed

# DependsOn
2

# Priority
high
